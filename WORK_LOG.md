# 障害福祉サービス書類作成支援アプリ - 作業ログ

## プロジェクト概要
- **プロジェクト名**: mirai-assist-app
- **目的**: 障害福祉サービスの相談支援専門員向け書類作成支援システム
- **理想状態**: 書類作成時間を現行の50％に短縮する業務効率化アプリ
- **技術スタック**: React 18 + TypeScript + Zustand + Tailwind CSS + Vite
- **開発環境**: Windows + Claude Code
- **リポジトリ**: https://github.com/miraku-mkt/mirai-assist-app

## 現在の開発状況（2025-08-15時点）

### ✅ 完成済み機能

#### 1. 基盤システム
- **認証システム**: 組織コード・ユーザーID・パスワードによるログイン
- **利用者管理**: 暗号化対応の利用者情報管理（実名・匿名表示切替）
- **データ永続化**: Zustandによるブラウザローカルストレージ
- **レスポンシブUI**: Tailwind CSSによるモダンなデザイン

#### 2. 面談カレンダー機能
- **月間・週間ビュー**: カレンダー形式での面談予定管理
- **開始・終了時間設定**: 面談の詳細時間管理
- **視覚的時間表示**: 週間ビューでの予定時間の可視化
- **利用者別管理**: 利用者ごとの面談スケジューリング

#### 3. 統一3ステップ書類作成システム
**共通プロセス**: 基本情報 → AI生成 → 確認・編集

##### サービス等利用計画（様式2-1）
- **場所**: `/plan` → 利用者選択 → 「作成」ボタン
- **必須ファイル**: 面談記録のみ
- **AI生成**: 専門知識に基づく自動生成
- **Excel出力**: 基本情報シート + サービス詳細シート

##### 週間計画表（様式2-2）
- **場所**: 計画作成画面で書類タイプ選択
- **統合管理**: サービス等利用計画と同じ操作感

##### ニーズ整理票
- **場所**: 計画作成画面で書類タイプ選択
- **専門的アセスメント**: インテーク→アセスメント→プランニング

#### 4. モニタリング報告書システム（様式3-1）
- **場所**: `/monitoring` → 利用者選択 → 「作成」ボタン
- **専門知識**: 170枚のマニュアル知識を永続化済み
- **希望創出型アプローチ**: 振り返り→対話→見通しの3段階プロセス
- **必須ファイル**: 面談記録のみ
- **Excel出力**: 基本情報シート + モニタリング項目シート

#### 5. Excel出力機能
- **ライブラリ**: xlsx（確実な出力保証）
- **出力場所**: 各書類の詳細表示画面
- **形式**: 複数シート構成、適切な列幅設定
- **ファイル名**: 利用者名_作成日形式

#### 6. ダッシュボード改善
- **実用性重視**: 統計表示から日常業務管理ツールに転換
- **面談管理**: 今日の面談予定、進行中面談の表示
- **進捗管理**: 利用者別の書類作成状況可視化
- **緊急対応**: 期限切れ間近の案件表示

### 🔧 技術的実装詳細

#### 専門知識の永続化
```typescript
// src/knowledge/monitoring-manual-knowledge.ts
// 170枚のマニュアル画像の知識を完全にコード化
export const HOPE_NURTURING_MONITORING_FRAMEWORK = {
  core_concept: "希望創出プロセス",
  three_phases: ["振り返り", "対話", "見通し"],
  // 完全な専門知識フレームワーク
}
```

#### AI生成システム
```typescript
// src/utils/aiPrompts.ts
// 各書類タイプに対応した専門的プロンプト
export const AI_PROMPTS = {
  servicePlan: { /* 計画作成用 */ },
  monitoringReport: { /* モニタリング用 */ },
  weeklySchedule: { /* 週間計画用 */ },
  needsAssessment: { /* アセスメント用 */ }
}
```

#### Excel出力システム
```typescript
// src/utils/excelExport.ts
export const exportServicePlanToExcel = (plan, userName, userInfo) => {
  // 複数シート対応、列幅自動調整
}
export const exportMonitoringReportToExcel = (report, userName, userInfo) => {
  // 専門様式対応、適切なファイル名
}
```

### 📁 プロジェクト構造

```
src/
├── components/
│   ├── auth/                 # 認証関連
│   ├── dashboard/            # ダッシュボード
│   ├── users/               # 利用者管理
│   ├── calendar/            # 面談カレンダー
│   ├── plan/                # 計画作成（NEW）
│   │   ├── PlanManagement.tsx
│   │   ├── PlanCreate.tsx
│   │   └── PlanView.tsx
│   ├── monitoring/          # モニタリング
│   ├── documents/           # 従来の書類作成
│   └── layout/              # レイアウト
├── stores/                  # Zustand状態管理
├── utils/                   # ユーティリティ
│   ├── aiPrompts.ts         # AI生成プロンプト
│   └── excelExport.ts       # Excel出力機能
├── knowledge/               # 専門知識（NEW）
│   └── monitoring-manual-knowledge.ts
└── types/                   # TypeScript型定義
```

### 🎯 開発哲学・重要な判断

#### 1. 「必須アプリ」を目指す
- 統計表示ではなく、日常業務に直結する機能
- 相談員が毎日使いたくなる実用的なツール
- 書類作成時間50%削減を具体的に実現

#### 2. UI/UX統一原則
- モニタリング管理と計画作成で同一デザイン
- 統一3ステップ方式（基本情報→AI生成→確認編集）
- カード形式レイアウトでの利用者一覧表示
- 直感的なアイコンとカラーリング

#### 3. 業務効率化の実現
- 必須ファイルを面談記録のみに簡素化
- AI生成による自動化（手動編集も可能）
- Excel出力による最終成果物の確実な提供
- 暗号化による個人情報保護

#### 4. 専門性の担保
- 170枚マニュアルの完全知識化
- 希望創出型モニタリングアプローチ
- 障害福祉制度に準拠した様式対応

### 🚀 開発サーバー情報
- **URL**: http://localhost:3005 （最新版、ELYZA統合済み）
- **起動コマンド**: `npm run dev`
- **認証情報**: 
  - 組織コード: DEMO001
  - ユーザーID: admin
  - パスワード: password123
- **注意**: 古いポート（3000-3004番）には古いバージョンが残存している可能性あり

### 📝 最近の主要更新（直近の作業）

#### 2025-08-16 ELYZA 7B instruct統合セッション（最新）
1. **ELYZA 7B instruct完全統合**:
   - ELYZA-japanese-Llama-2-7b-instruct（4bit量子化GGUF）の統合実装
   - `src/services/llmClient.ts`でLLMClientクラスを実装
   - Llama 2 Chat形式（`[INST]...[/INST]`）を採用
   - 日本語敬体・公的文書向け出力設定

2. **4つの書類タイプすべてでLLM統合**:
   - ニーズ整理票、サービス等利用計画、週間計画表、モニタリング報告書
   - 既存の`generateDocumentWithAI`関数をELYZA対応に更新
   - 各書類タイプの専門的プロンプトでLLM生成

3. **技術仕様の実装**:
   - **ランタイム**: フロントエンド環境用モック版（本番ではnode-llama-cpp）
   - **設定**: .env.exampleにELYZA専用パラメータを追加
   - **ログ方針**: 入力/出力本文は非ログ、メタ情報のみ出力
   - **CPU実行**: 完全オンプレミス設計

4. **インフラ設定**:
   - `models/`ディレクトリの作成とREADME
   - ポート設定の調整（3005で動作確認）
   - 依存関係の調整（フロントエンド互換性）

5. **受け入れ基準の達成**:
   - 既存の4ユースケースすべてでLLMClient.generate()統合
   - 例外時の安全なフォールバック（モック応答）
   - 既存テンプレ順序保持、空欄「（該当なし）」自動補完
   - 応答時間メタ情報の表示

#### 2025-08-15 最新セッション（前回）
1. **ポート問題解決**: 3002番ポートで最新版アプリを正常起動
2. **計画作成画面の完全復旧**:
   - PlanManagementコンポーネントをシンプルな動作する状態に修正
   - 実名表示機能を復旧（getUserByIdで復号化）
   - 検索機能を実名・障害種別で動作するように修正
3. **UI整理**:
   - 利用者管理画面から書類作成アイコンを削除
   - 新しい計画作成タブに統一化完了
   - 古いDocumentCreateコンポーネントはシステム上残存しつつUIからは非表示
4. **ルーティング問題修正**: ダッシュボードから新しい計画作成画面への正しい遷移
5. **Excel出力機能実装**: xlsxライブラリ導入、確実なExcel出力
6. **計画作成タブ追加**: 統一3ステップシステムの完成
7. **必須ファイル簡素化**: 面談記録のみに変更（業務効率化）
8. **UI統一化**: モニタリング管理のデザイン統一
9. **useEffect修正**: 無限ループ問題の解決
10. **書類統合**: ニーズ整理票・週間計画表の計画作成タブ統合
11. **プライバシー説明の正確化**: 「匿名化表示」から「暗号化保存・復号化表示」に修正

### 🎯 次回以降の開発課題

#### 短期課題
1. **ELYZA本番環境対応**: Node.jsサーバー分離、実際のllama-cpp統合
2. **ELYZAモデルファイル配置**: 4bit量子化GGUFファイルのダウンロードと配置
3. **AI生成精度向上**: より専門的な内容生成の調整
4. **Excel出力のテスト**: 実際のファイル出力確認
5. **ユーザビリティテスト**: 実際の相談員による使用感確認

#### 中期課題
1. **印刷レイアウト最適化**: 公的書類としての体裁
2. **データバックアップ機能**: 重要データの保護
3. **多職種連携機能**: 事業所との情報共有

#### 長期課題
1. **クラウド対応**: 複数拠点での利用
2. **API連携**: 既存システムとの統合
3. **モバイル対応**: タブレット・スマートフォン最適化

### 🔧 キャッシュ・エラー対策

#### 実装済み対策
```typescript
// ErrorBoundary - 予期しないエラーを捕捉
class ErrorBoundary extends Component {
  // アプリ全体を保護し、エラー時に適切な画面を表示
}

// 各コンポーネントに更新ボタン実装
const handleRefresh = () => {
  setIsRefreshing(true)
  setTimeout(() => {
    setIsRefreshing(false)
    window.location.reload() // 強制リロードでキャッシュクリア
  }, 500)
}

// ルーティング修正
// ダッシュボード → /documents/{userId} から /plan に変更
navigate('/plan') // 新しい計画作成画面へ統一
```

#### 問題の原因と解決
- **原因**: 旧コンポーネントへのリンクが残存
- **解決**: ProgressOverview.tsxのhandleUserClick修正
- **対策**: ErrorBoundaryで予期しないエラーを防止
- **改善**: 更新ボタンでユーザー自身がキャッシュクリア可能

### 💡 重要な技術的知見

#### Zustand状態管理
```typescript
// 暗号化対応の利用者情報管理
const useUserStore = create<UserStore>((set, get) => ({
  users: [],
  currentUser: null,
  getUserById: (id) => {
    // 復号化処理
    return decryptUserData(user)
  }
}))
```

#### 日付処理
```typescript
// date-fns + 日本語ロケール
import { format } from 'date-fns'
import { ja } from 'date-fns/locale'

format(new Date(), 'yyyy年M月d日', { locale: ja })
```

#### ファイルアップロード
```typescript
// テキストファイル読み取り
const reader = new FileReader()
reader.onload = (e) => {
  const content = e.target?.result as string
  // AI生成用コンテンツとして使用
}
reader.readAsText(file)
```

### 🎨 デザインシステム

#### カラーパレット
- **Primary**: Blue（メインアクション）
- **Success**: Green（完了・成功状態）
- **Warning**: Yellow（注意・期限切れ間近）
- **Danger**: Red（エラー・未完了）

#### アイコン使用ルール
- **Plus/PlusCircle**: 新規作成
- **Eye**: 詳細表示・確認
- **Edit**: 編集
- **FileSpreadsheet**: Excel出力
- **Download**: テキスト出力
- **User**: 利用者関連
- **Calendar**: 日時関連

### 🔒 セキュリティ対応
- **個人情報暗号化**: AES暗号化によるデータ保護
- **ローカル保存**: インターネット接続不要
- **匿名化表示**: 実名・匿名の切り替え機能

### 📚 参考資料
- 障害福祉サービス関連様式（厚生労働省）
- 相談支援専門員研修資料
- 希望創出型支援アプローチ理論

---

## Claude Code再起動時の確認事項

1. **開発サーバー確認**: `npm run dev` でhttp://localhost:3005起動（ELYZA統合版）
2. **最新コミット確認**: `git log --oneline -5` で最近の変更確認  
3. **作業中機能確認**: 
   - 計画作成タブ（/plan）の動作
   - ELYZA LLM統合によるAI生成機能
   - Excel出力ボタンの表示
   - モニタリング作成の動作
4. **ELYZA統合確認**: 書類作成時のLLM生成動作とログ出力
5. **課題把握**: 上記「次回以降の開発課題」セクション参照

## 開発者への引き継ぎメッセージ

このアプリは「技術的に優れたアプリ」ではなく「現場で愛される必須アプリ」を目指しています。相談支援専門員の日常業務を50%効率化し、利用者により多くの時間を使えるようにすることが最終目標です。

技術選択も業務効率化を最優先に行い、複雑さよりも実用性を重視してください。新機能追加時は必ず「これは相談員の日常業務を楽にするか？」を自問してください。

最後に、170枚のマニュアル知識の永続化という大きな成果を活かし、真に専門的で価値のある支援ツールとして発展させていってください。

---

*このログは継続的に更新してください。重要な判断や技術選択の理由は必ず記録してください。*